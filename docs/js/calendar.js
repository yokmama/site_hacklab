// Shared slot configuration for trial lessons
var SlotConfig = {
  dayOfWeek: 6, // Saturday
  timeSlots: [
    { start: '09:00', end: '10:00' },
    { start: '12:00', end: '13:00' }
  ],
  title: '体験レッスン',
  color: '#6DCB2A'
};

// Generate trial lesson slots for a given date range
// Returns array of { dateStr, startTime, endTime, title, date }
function generateTrialSlots(startDate, endDate) {
  var slots = [];
  for (var d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
    if (d.getDay() === SlotConfig.dayOfWeek) {
      var year = d.getFullYear();
      var month = (d.getMonth() + 1).toString().padStart(2, '0');
      var day = d.getDate().toString().padStart(2, '0');
      var dateStr = year + '-' + month + '-' + day;

      for (var i = 0; i < SlotConfig.timeSlots.length; i++) {
        var ts = SlotConfig.timeSlots[i];
        slots.push({
          dateStr: dateStr,
          startTime: ts.start,
          endTime: ts.end,
          title: SlotConfig.title,
          date: new Date(d)
        });
      }
    }
  }
  return slots;
}

document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ja',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'listMonth,dayGridMonth'
    },
    buttonText: {
      today: '今日',
      month: '月',
      list: 'リスト'
    },
    height: 'auto',
    events: function(info, successCallback, failureCallback) {
      // 1. Static Trial Lessons (Recurring) - using shared generateTrialSlots
      var slots = generateTrialSlots(info.start, info.end);
      var trialEvents = slots.map(function(slot) {
        return {
          title: slot.title,
          start: slot.dateStr + 'T' + slot.startTime + ':00',
          end: slot.dateStr + 'T' + slot.endTime + ':00',
          color: SlotConfig.color,
          url: '#contact'
        };
      });

      // 2. Fetch Dynamic Events from JSON (Generated by GitHub Actions)
      fetch('data/events.json?v=' + new Date().getTime())
        .then(response => {
            if (!response.ok) {
                // If file doesn't exist yet (local dev), just return trials
                console.warn('events.json not found, showing only static events.');
                return []; 
            }
            return response.json();
        })
        .then(dynamicEvents => {
            // Merge static and dynamic events
            successCallback(trialEvents.concat(dynamicEvents));
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            successCallback(trialEvents); // Fallback to just trials
        });
    },
    eventDidMount: function(info) {
      if (info.event.extendedProps.description || info.event.url) {
        let description = info.event.extendedProps.description || '';
        if (description.length > 30) {
            description = description.substring(0, 30) + '...';
        }

        // Format time range (e.g. 09:00 - 10:00)
        let timeRange = '';
        if (info.event.start) {
            const formatTime = (date) => date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            timeRange = `${formatTime(info.event.start)}`;
            if (info.event.end) {
                timeRange += ` - ${formatTime(info.event.end)}`;
            }
        }

        // Determine Button Action
        let buttonHtml = '';
        if (info.event.title.includes('体験レッスン')) {
            // For Trial Lessons: Update iframe and scroll to contact
            const dateStr = info.event.start.toLocaleDateString();
            const fillText = `${dateStr} ${timeRange} ${info.event.title}`;
            // Use encodeURIComponent for safe URL insertion
            const safeText = encodeURIComponent(fillText);
            
            buttonHtml = `<a href="#contact" onclick="updateContactForm('${safeText}')" class="btn-tooltip" style="display: inline-block; margin-top: 5px; padding: 4px 10px; background: #6DCB2A; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">申し込む</a>`;
        } else if (info.event.url) {
            // For External Events: Open in new tab
            buttonHtml = `<a href="${info.event.url}" target="_blank" class="btn-tooltip" style="display: inline-block; margin-top: 5px; padding: 4px 10px; background: #6DCB2A; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">申し込む</a>`;
        }

        tippy(info.el, {
          content: `
            <div style="text-align: left; font-size: 0.9em;">
              <strong>${info.event.title}</strong><br>
              <div style="font-size: 1.1em; font-weight: bold; color: #333; margin: 5px 0;">${timeRange}</div>
              ${description ? `<div style="margin: 5px 0; color: #333;">${description}</div>` : ''}
              ${buttonHtml}
            </div>
          `,
          allowHTML: true,
          interactive: true,
          theme: 'light',
          placement: 'top',
        });
      }
    },
    eventClick: function(info) {
      if (info.event.url && !info.event.title.includes('体験レッスン')) {
        info.jsEvent.preventDefault();
        window.open(info.event.url, '_blank'); 
      } else if (info.event.title.includes('体験レッスン')) {
          info.jsEvent.preventDefault();
          // Also trigger the form update if clicking the event itself
          const timeRange = info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + (info.event.end ? ' - ' + info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '');
          const dateStr = info.event.start.toLocaleDateString();
          const fillText = `${dateStr} ${timeRange} ${info.event.title}`;
          updateContactForm(encodeURIComponent(fillText));
          document.getElementById('contact').scrollIntoView({behavior: 'smooth'});
      }
    }
  });
  calendar.render();

  // Global function to update Google Form iframe + sync slot picker
  window.updateContactForm = function(encodedText) {
      const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSc3YmdS1dzUzilBTQarXmwGIP4ZmBIi7zlB0Q99yBTDQERBOA/viewform";
      const entryId = "entry.1487440665";
      const newSrc = `${baseUrl}?usp=pp_url&${entryId}=${encodedText}&embedded=true`;

      const iframe = document.getElementById('google-form-frame');
      if (iframe) {
          iframe.src = newSrc;
      }

      // T006: Sync slot picker highlight state
      var buttons = document.querySelectorAll('.slot-btn');
      var decodedText = decodeURIComponent(encodedText);
      buttons.forEach(function(btn) {
          btn.classList.remove('slot-selected');
          // Match by comparing decoded fill text (partial match on date+time)
          var btnFill = decodeURIComponent(btn.getAttribute('data-fill') || '');
          if (btnFill && decodedText.indexOf(btnFill) !== -1) {
              btn.classList.add('slot-selected');
          }
      });
  };

  // T004: Render slot picker buttons
  function renderSlotPicker() {
      var container = document.getElementById('slot-picker');
      if (!container) return;

      var now = new Date();
      var endDate = new Date(now);
      endDate.setMonth(endDate.getMonth() + 1); // 1 month ahead

      var slots = generateTrialSlots(now, endDate);

      // Filter: only future slots (skip past start times on current Saturday)
      var currentHour = now.getHours();
      var currentMin = now.getMinutes();
      var todayStr = now.getFullYear() + '-' +
          (now.getMonth() + 1).toString().padStart(2, '0') + '-' +
          now.getDate().toString().padStart(2, '0');

      slots.forEach(function(slot) {
          // Skip past slots on today
          if (slot.dateStr === todayStr) {
              var parts = slot.startTime.split(':');
              var slotHour = parseInt(parts[0], 10);
              var slotMin = parseInt(parts[1], 10);
              if (slotHour < currentHour || (slotHour === currentHour && slotMin <= currentMin)) {
                  return;
              }
          }
          // Skip dates in the past (before today)
          if (slot.dateStr < todayStr) {
              return;
          }

          // Build label: "2/14(土) 9:00 - 10:00"
          var d = slot.date;
          var dayNames = ['日', '月', '火', '水', '木', '金', '土'];
          var label = (d.getMonth() + 1) + '/' + d.getDate() + '(' + dayNames[d.getDay()] + ') ' +
              slot.startTime + ' - ' + slot.endTime;

          // Build fillText matching calendar format: "YYYY/M/D HH:MM - HH:MM 体験レッスン"
          var fillText = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' +
              slot.startTime + ' - ' + slot.endTime + ' ' + slot.title;

          var btn = document.createElement('button');
          btn.className = 'slot-btn';
          btn.textContent = label;
          btn.setAttribute('data-fill', fillText);

          // T005: Click handler
          btn.addEventListener('click', function() {
              // Remove previous selection
              document.querySelectorAll('.slot-btn').forEach(function(b) {
                  b.classList.remove('slot-selected');
              });
              // Highlight this button
              btn.classList.add('slot-selected');
              // Update Google Form
              updateContactForm(encodeURIComponent(fillText));
              // Show confirmation message
              var confirmation = document.getElementById('slot-confirmation');
              if (confirmation) {
                  confirmation.textContent = '\u2713 体験希望日が設定されました';
                  confirmation.classList.add('show');
                  clearTimeout(window._slotConfirmTimer);
                  window._slotConfirmTimer = setTimeout(function() {
                      confirmation.classList.remove('show');
                  }, 3000);
              }
          });

          container.appendChild(btn);
      });
  }

  renderSlotPicker();
});
