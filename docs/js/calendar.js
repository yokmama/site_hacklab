document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ja',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'listMonth,dayGridMonth'
    },
    buttonText: {
      today: '今日',
      month: '月',
      list: 'リスト'
    },
    height: 'auto',
    events: function(info, successCallback, failureCallback) {
      // 1. Static Trial Lessons (Recurring)
      const trialEvents = [];
      const start = new Date(info.start);
      const end = new Date(info.end);

      // Loop through each day in the range to find Saturdays
      for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() === 6) { // 6 = Saturday
          // Fix: Use local time to construct YYYY-MM-DD to avoid UTC shift
          const year = d.getFullYear();
          const month = (d.getMonth() + 1).toString().padStart(2, '0');
          const day = d.getDate().toString().padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;

          // 9:00 - 10:00 Slot
          trialEvents.push({
            title: '体験レッスン',
            start: dateStr + 'T09:00:00',
            end: dateStr + 'T10:00:00',
            color: '#6DCB2A', // Brand Green
            url: '#contact' // Link to form
          });
          // 12:00 - 13:00 Slot
          trialEvents.push({
            title: '体験レッスン',
            start: dateStr + 'T12:00:00',
            end: dateStr + 'T13:00:00',
            color: '#6DCB2A',
            url: '#contact'
          });
        }
      }

      // 2. Fetch Dynamic Events from JSON (Generated by GitHub Actions)
      fetch('data/events.json?v=' + new Date().getTime())
        .then(response => {
            if (!response.ok) {
                // If file doesn't exist yet (local dev), just return trials
                console.warn('events.json not found, showing only static events.');
                return []; 
            }
            return response.json();
        })
        .then(dynamicEvents => {
            // Merge static and dynamic events
            successCallback(trialEvents.concat(dynamicEvents));
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            successCallback(trialEvents); // Fallback to just trials
        });
    },
    eventDidMount: function(info) {
      if (info.event.extendedProps.description || info.event.url) {
        let description = info.event.extendedProps.description || '';
        if (description.length > 30) {
            description = description.substring(0, 30) + '...';
        }

        // Format time range (e.g. 09:00 - 10:00)
        let timeRange = '';
        if (info.event.start) {
            const formatTime = (date) => date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            timeRange = `${formatTime(info.event.start)}`;
            if (info.event.end) {
                timeRange += ` - ${formatTime(info.event.end)}`;
            }
        }

        // Determine Button Action
        let buttonHtml = '';
        if (info.event.title.includes('体験レッスン')) {
            // For Trial Lessons: Update iframe and scroll to contact
            const dateStr = info.event.start.toLocaleDateString();
            const fillText = `${dateStr} ${timeRange} ${info.event.title}`;
            // Use encodeURIComponent for safe URL insertion
            const safeText = encodeURIComponent(fillText);
            
            buttonHtml = `<a href="#contact" onclick="updateContactForm('${safeText}')" class="btn-tooltip" style="display: inline-block; margin-top: 5px; padding: 4px 10px; background: #6DCB2A; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">申し込む</a>`;
        } else if (info.event.url) {
            // For External Events: Open in new tab
            buttonHtml = `<a href="${info.event.url}" target="_blank" class="btn-tooltip" style="display: inline-block; margin-top: 5px; padding: 4px 10px; background: #6DCB2A; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">申し込む</a>`;
        }

        tippy(info.el, {
          content: `
            <div style="text-align: left; font-size: 0.9em;">
              <strong>${info.event.title}</strong><br>
              <div style="font-size: 1.1em; font-weight: bold; color: #333; margin: 5px 0;">${timeRange}</div>
              ${description ? `<div style="margin: 5px 0; color: #333;">${description}</div>` : ''}
              ${buttonHtml}
            </div>
          `,
          allowHTML: true,
          interactive: true,
          theme: 'light',
          placement: 'top',
        });
      }
    },
    eventClick: function(info) {
      if (info.event.url && !info.event.title.includes('体験レッスン')) {
        info.jsEvent.preventDefault();
        window.open(info.event.url, '_blank'); 
      } else if (info.event.title.includes('体験レッスン')) {
          info.jsEvent.preventDefault();
          // Also trigger the form update if clicking the event itself
          const timeRange = info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + (info.event.end ? ' - ' + info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '');
          const dateStr = info.event.start.toLocaleDateString();
          const fillText = `${dateStr} ${timeRange} ${info.event.title}`;
          updateContactForm(encodeURIComponent(fillText));
          document.getElementById('contact').scrollIntoView({behavior: 'smooth'});
      }
    }
  });
  calendar.render();

  // Global function to update Google Form iframe
  window.updateContactForm = function(encodedText) {
      const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSc3YmdS1dzUzilBTQarXmwGIP4ZmBIi7zlB0Q99yBTDQERBOA/viewform";
      const entryId = "entry.1487440665";
      const newSrc = `${baseUrl}?usp=pp_url&${entryId}=${encodedText}&embedded=true`;
      
      const iframe = document.getElementById('google-form-frame');
      if (iframe) {
          iframe.src = newSrc;
      }
  };
});
