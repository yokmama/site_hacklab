document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ja',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'listMonth,dayGridMonth'
    },
    buttonText: {
      today: '今日',
      month: '月',
      list: 'リスト'
    },
    height: 'auto',
    events: function(info, successCallback, failureCallback) {
      // 1. Static Trial Lessons (Recurring)
      const trialEvents = [];
      const start = new Date(info.start);
      const end = new Date(info.end);

      // Loop through each day in the range to find Saturdays
      for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() === 6) { // 6 = Saturday
          // Fix: Use local time to construct YYYY-MM-DD to avoid UTC shift
          const year = d.getFullYear();
          const month = (d.getMonth() + 1).toString().padStart(2, '0');
          const day = d.getDate().toString().padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;

          // 9:00 - 10:00 Slot
          trialEvents.push({
            title: '体験レッスン',
            start: dateStr + 'T09:00:00',
            end: dateStr + 'T10:00:00',
            color: '#6DCB2A', // Brand Green
            url: '#contact' // Link to form
          });
          // 12:00 - 13:00 Slot
          trialEvents.push({
            title: '体験レッスン',
            start: dateStr + 'T12:00:00',
            end: dateStr + 'T13:00:00',
            color: '#6DCB2A',
            url: '#contact'
          });
        }
      }

      // 2. Fetch Dynamic Events from JSON (Generated by GitHub Actions)
      fetch('data/events.json')
        .then(response => {
            if (!response.ok) {
                // If file doesn't exist yet (local dev), just return trials
                console.warn('events.json not found, showing only static events.');
                return []; 
            }
            return response.json();
        })
        .then(dynamicEvents => {
            // Merge static and dynamic events
            successCallback(trialEvents.concat(dynamicEvents));
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            successCallback(trialEvents); // Fallback to just trials
        });
    },
    eventClick: function(info) {
      if (info.event.url) {
        info.jsEvent.preventDefault(); // don't let the browser navigate
        if (info.event.extendedProps.description) {
            alert(info.event.title + "\n" + info.event.extendedProps.description);
        }
        window.open(info.event.url, '_blank');
      }
    }
  });
  calendar.render();
});
